<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idonstore | Content Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Idonstore Brand Colors */
            --brand-blue: #064B7C;
            --brand-orange: #F46C3A;
            --brand-blue-light: #e6f0f8;
            --brand-orange-light: #fff3ed;
            
            --text-main: #1e293b;
            --text-muted: #64748b;
            --bg-page: #f8fafc;
            --white: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* --- HEADER & NAVIGATION --- */
        .app-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--brand-blue);
            padding: 24px 32px;
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px -5px rgba(6, 75, 124, 0.3);
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
            color: var(--white);
        }

        .brand { display: flex; align-items: center; gap: 16px; }
        .brand img { 
            height: 64px; 
            width: 64px; 
            border-radius: 12px; 
            object-fit: contain; 
            border: 2px solid rgba(255, 255, 255, 0.2); 
            background: white; 
            padding: 4px; 
        }
        .brand .title-group { display: flex; flex-direction: column; }
        .brand h1 { font-size: 1.35rem; font-weight: 800; color: var(--white); letter-spacing: -0.02em; line-height: 1.2; }
        .brand .subtitle { font-size: 0.95rem; color: var(--brand-blue-light); font-weight: 500; opacity: 0.9; }

        .week-switcher {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: var(--radius-md);
            backdrop-filter: blur(4px);
        }

        .week-switcher .btn-ghost {
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .week-switcher .btn-ghost:hover { background: var(--brand-orange); border-color: var(--brand-orange); }
        .week-switcher .btn-ghost:disabled { opacity: 0.3; cursor: not-allowed; }

        /* --- STATS & PROGRESS --- */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px 16px;
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }

        .stat-card span { display: block; font-size: 1.5rem; font-weight: 800; }
        .stat-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); }

        .progress-container {
            height: 10px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 32px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand-blue), var(--brand-orange));
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* --- TOOLBAR --- */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* --- CONTENT GRID --- */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        .post-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid #eef2f6;
        }
        .post-card:not(.is-placeholder):hover { transform: translateY(-6px); box-shadow: 0 12px 20px -5px rgba(0,0,0,0.1); border-color: var(--brand-blue-light); }

        /* Media / Carousel Styles */
        .media-box {
            position: relative;
            aspect-ratio: 1/1;
            background: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .carousel-container {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .carousel-item {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-item img, 
        .carousel-item video, 
        .carousel-item iframe,
        .media-box > img,
        .media-box > video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: none;
            display: block;
        }

        /* Video Controls Custom */
        .video-control-overlay {
            position: absolute;
            bottom: 12px;
            left: 12px;
            z-index: 10;
        }

        .mute-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px;
            border-radius: 50%;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        /* Carousel Nav */
        .carousel-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            pointer-events: none;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .post-card:hover .carousel-nav { opacity: 1; }

        .nav-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: var(--shadow);
            color: var(--brand-blue);
        }
        .nav-btn:hover { background: white; color: var(--brand-orange); }

        .carousel-dots {
            position: absolute;
            bottom: 12px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 4px;
            z-index: 10;
        }
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transition: all 0.2s;
        }
        .dot.active {
            background: white;
            width: 12px;
            border-radius: 10px;
        }

        .media-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
        }
        .post-card:hover .media-actions { opacity: 1; }
        
        .action-icon-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: var(--brand-blue);
            font-size: 16px;
            text-decoration: none;
            position: relative;
        }
        .action-icon-btn:hover { background: var(--brand-orange); transform: scale(1.1); color: white; }
        .action-icon-btn.is-loading::after {
            content: ""; position: absolute; inset: 0; background: rgba(255,255,255,0.8);
            border-radius: inherit; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .card-details { padding: 16px; flex-grow: 1; display: flex; flex-direction: column; }
        .badge-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .day-badge { font-weight: 700; font-size: 0.7rem; color: var(--brand-blue); background: var(--brand-blue-light); padding: 4px 10px; border-radius: 6px; }
        .type-badge { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

        .caption-container {
            margin-bottom: 16px;
            background: #f9fafb;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #f1f5f9;
            position: relative;
        }
        .caption {
            font-size: 0.85rem;
            color: var(--text-main);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 8px;
            white-space: pre-wrap;
        }
        .caption.expanded {
            -webkit-line-clamp: unset;
            display: block;
        }
        .caption-controls {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            border-top: 1px solid #eef2f6;
            padding-top: 8px;
        }
        .icon-link {
            background: none;
            border: none;
            color: var(--brand-blue);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        .icon-link:hover { background: var(--brand-blue-light); color: var(--brand-orange); }
        .icon-link svg { width: 16px; height: 16px; pointer-events: none; }

        .action-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: auto;
        }

        .btn {
            font-family: inherit;
            font-weight: 700;
            font-size: 0.8rem;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .btn-primary { background: var(--brand-blue); color: var(--white); }
        .btn-primary:hover:not(:disabled) { background: #043a61; }
        
        .btn-accent { background: var(--brand-orange); color: var(--white); }
        .btn-accent:hover:not(:disabled) { background: #d95a2b; }

        .btn-danger-light { background: #fef2f2; color: var(--danger); border: 1px solid #fee2e2; }
        .btn-danger-light:hover:not(:disabled) { background: #fee2e2; }

        .btn-ghost-dark { background: #f1f5f9; color: var(--text-muted); }
        .btn-ghost-dark:hover:not(:disabled) { background: #e2e8f0; color: var(--text-main); }
        
        .status-pill {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 4px;
            border-radius: 6px;
            margin-top: 8px;
            text-transform: uppercase;
        }
        .st-pending { background: #fffbeb; color: #b45309; }
        .st-approved { background: #ecfdf5; color: #047857; }
        .st-rejected { background: #fff1f2; color: #be123c; }
        .st-empty { background: #f1f5f9; color: #94a3b8; }

        .rejection-note {
            margin-top: 10px;
            background: #fff1f2;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            border-left: 3px solid var(--danger);
            color: #991b1b;
        }

        .feedback-section {
            margin-top: 60px;
            background: var(--white);
            padding: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            text-align: center;
        }
        .feedback-input {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid #e2e8f0;
            font-family: inherit;
            resize: none;
            transition: border-color 0.2s;
        }
        .feedback-input:focus { outline: none; border-color: var(--brand-blue); }

        .card-loader {
            position: absolute; inset: 0; background: rgba(255,255,255,0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; backdrop-filter: blur(2px);
        }
        .spinner { width: 24px; height: 24px; border: 3px solid #e2e8f0; border-top-color: var(--brand-orange); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .media-viewer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; align-items: center; justify-content: center; padding: 40px;
        }
        .media-viewer-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
        .media-viewer-close { 
            position: absolute; top: -30px; right: 0; background: var(--white); border: none; 
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: 800; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center; color: var(--brand-blue);
        }

        .hidden { display: none !important; }

        .main-footer {
            margin-top: 64px;
            padding: 48px 24px;
            background: var(--brand-blue);
            color: var(--white);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .footer-content h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; }
        .footer-content p { font-size: 0.85rem; color: var(--brand-blue-light); opacity: 0.8; margin-bottom: 24px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .footer-links { display: flex; justify-content: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
        .footer-link { 
            color: var(--white); 
            text-decoration: none; 
            font-weight: 700; 
            font-size: 0.8rem; 
            padding: 8px 18px; 
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 8px;
            transition: all 0.2s;
            background: rgba(255,255,255,0.05);
        }
        .footer-link:hover { background: var(--brand-orange); border-color: var(--brand-orange); transform: translateY(-2px); }
        .footer-bottom { border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 24px; font-size: 0.75rem; opacity: 0.6; margin-top: 24px; }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <nav class="app-bar">
        <div class="brand">
            <img id="brand-logo" src="https://via.placeholder.com/64?text=IDON" alt="Logo">
            <div class="title-group">
                <h1 id="brand-title">Idonstores Approval</h1>
                <p class="subtitle">Review and approve your social media content</p>
            </div>
        </div>
        <div class="week-switcher">
            <button class="btn-ghost" onclick="wkGoPrev()">‚Üê</button>
            <span id="wk-current-label" style="font-size: 0.8rem; font-weight: 700; padding: 0 8px;">Loading Week...</span>
            <button class="btn-ghost" id="next-wk-btn" onclick="wkGoNext()">‚Üí</button>
        </div>
    </nav>

    <!-- Stats Summary -->
    <div class="dashboard-stats">
        <div class="stat-card"><span id="approved-count" style="color: var(--success);">0</span><div class="stat-label">Approved</div></div>
        <div class="stat-card"><span id="pending-count" style="color: var(--warning);">0</span><div class="stat-label">Pending</div></div>
        <div class="stat-card"><span id="rejected-count" style="color: var(--danger);">0</span><div class="stat-label">Rejected</div></div>
        <div class="stat-card"><span id="progressPct">0%</span><div class="stat-label">Progress</div></div>
    </div>
    <div class="progress-container">
        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
    </div>

    <!-- Quick Actions -->
    <div class="toolbar">
        <div id="notice" style="font-size: 0.8rem; font-weight: 600; color: var(--brand-blue); min-height: 1.2rem;"></div>
        <div style="display: flex; gap: 8px;">
            <button class="btn btn-ghost-dark" onclick="viewAllCaptions()" title="View all captions">üìã Captions</button>
            <button class="btn btn-primary" onclick="bulkApprove()">‚úì Approve All</button>
            <button class="btn btn-danger-light" onclick="bulkReject()">‚úó Reject All</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-grid" id="content-grid">
        <p style="grid-column: 1/-1; text-align: center; color: #94a3b8; padding: 40px;">Fetching content...</p>
    </div>

    <!-- Feedback Area -->
    <section class="feedback-section">
        <h2 style="color: var(--brand-blue); margin-bottom: 8px;">Feedback & Requests</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem;">Need a call or have a general note regarding this week's content?</p>
        <textarea id="feedback-note" class="feedback-input" rows="3" placeholder="Type your notes or questions here..."></textarea>
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
            <button class="btn btn-accent" onclick="submitFeedback('Call Requested')">Request Call / Meeting</button>
            <button class="btn btn-primary" onclick="submitFeedback('Note Saved')">Send Message</button>
        </div>
    </section>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <h3 id="footer-brand-name">Idonstore Approval Portal</h3>
            <p>Your centralized hub for social media content management. We help you stay consistent and grow your online presence effortlessly.</p>
            <div class="footer-links">
                <a href="tel:07026710999" class="footer-link">Support: 07026710999</a>
                <a href="https://wa.me/2347026710999" target="_blank" class="footer-link">WhatsApp Support</a>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2026 Idonstore & Sky Q. All rights reserved.
        </div>
    </footer>
</div>

<!-- Modal Screen -->
<div id="screen" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1000; display:flex; align-items:center; justify-content:center; padding:20px; backdrop-filter: blur(4px);">
    <div style="background:var(--white); padding:32px; border-radius:24px; max-width:600px; width:100%; max-height: 85vh; overflow-y: auto;">
        <h2 id="screen-title" style="margin-bottom: 8px; color: var(--brand-blue);">Notice</h2>
        <div id="screen-body" style="margin-bottom: 24px;"></div>
        <div id="screen-actions" style="display: flex; gap: 8px;">
            <button id="screen-close-btn" class="btn btn-primary" style="width: 100%;" onclick="closeScreen()">Close</button>
        </div>
    </div>
</div>

<!-- Media Viewer -->
<div id="media-viewer" class="media-viewer-overlay hidden">
    <div class="media-viewer-content">
        <button class="media-viewer-close" onclick="closeMediaViewer()">‚úï</button>
        <div id="media-viewer-inner" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"></div>
    </div>
</div>

<script>
/* =========================
   CONFIG & STATE
   ========================= */
const supabaseUrl = 'https://ohflkfevuapwqtkpsqlo.supabase.co';
const supabaseKey = 'sb_publishable_U2yJZn0K-XQF_0bGPfGvJQ_hA5-ja0F';

let _supabase = null;
let currentBrand = null;
let items = []; 
let activeStartDate = null;
let carouselIndices = {}; 
let carouselIntervals = {}; 

const ICON_EXPAND = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
const ICON_COPY = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>`;
const ICON_DL = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;

/* =========================
   INITIALIZATION
   ========================= */
async function init() {
    if (typeof supabase === 'undefined') {
        setTimeout(init, 100);
        return;
    }
    _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const params = new URLSearchParams(window.location.search);
    const slug = params.get('brand') || 'idonstore';
    try {
        const { data: brand, error: brandError } = await _supabase.from('brands').select('*').eq('slug', slug).single();
        if (brandError) {
            console.error("Brand Fetch Error:", brandError);
            return showNotice("Error finding brand: " + brandError.message);
        }
        if (!brand) return showNotice("Brand not found.");
        
        currentBrand = brand;
        updateBrandUI();
        activeStartDate = getMonday(new Date());
        loadWeekData();
    } catch (e) { 
        console.error("Init Exception:", e); 
    }
}

function getMonday(d) {
    d = new Date(d);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
    const mon = new Date(d.setDate(diff));
    mon.setHours(0,0,0,0);
    return mon;
}

function formatLocalDate(d) {
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

function updateBrandUI() {
    if (currentBrand.logo_url) document.getElementById('brand-logo').src = currentBrand.logo_url;
    document.getElementById('brand-title').textContent = "Idonstores Approval";
    const footerName = document.getElementById('footer-brand-name');
    if (footerName && currentBrand.name) {
        footerName.textContent = currentBrand.name + " Approval Portal";
    }
}

async function loadWeekData() {
    if (!_supabase || !currentBrand) return;
    const grid = document.getElementById('content-grid');
    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px;"><div class="spinner" style="margin: 0 auto 16px;"></div><p style="color: #94a3b8;">Loading content...</p></div>';
    
    const start = new Date(activeStartDate);
    const end = new Date(activeStartDate); end.setDate(end.getDate() + 7);
    
    try {
        const { data: slots, error } = await _supabase.from('post_slots')
            .select(`
                id, scheduled_date, current_status, 
                post_versions (
                    id, version_number, caption, is_approved, 
                    media_assets (file_url, order_index)
                )
            `)
            .eq('brand_id', currentBrand.id)
            .gte('scheduled_date', formatLocalDate(start))
            .lt('scheduled_date', formatLocalDate(end))
            .order('scheduled_date', { ascending: true });

        if (error) {
            console.error("Supabase Query Error:", error);
            grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #ef4444; padding: 40px;">
                <p><strong>Error loading content:</strong></p>
                <p style="font-size: 0.8rem; margin-top: 8px;">${error.message}</p>
            </div>`;
            return;
        }

        const dayItems = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(activeStartDate); date.setDate(date.getDate() + i);
            const ds = formatLocalDate(date);
            const slot = (slots || []).find(s => s.scheduled_date === ds);
            if (slot) {
                const versions = slot.post_versions || [];
                const latestVersion = [...versions].sort((a,b) => b.version_number - a.version_number)[0];
                carouselIndices[slot.id] = 0;
                dayItems.push({ 
                    id: slot.id, 
                    version_id: latestVersion?.id, 
                    date, 
                    status: slot.current_status, 
                    caption: latestVersion?.caption || '', 
                    assets: (latestVersion?.media_assets || []).sort((a,b) => a.order_index - b.order_index), 
                    isEmpty: false 
                });
            } else {
                dayItems.push({ id: `empty-${ds}`, date, status: 'empty', caption: 'We are currently working on it.', assets: [], isEmpty: true });
            }
        }
        items = dayItems;
        document.getElementById('wk-current-label').textContent = `Week of ${start.toLocaleDateString()}`;
        renderCards();
        startAutoSlides();
    } catch (err) { 
        console.error("Load Data Exception:", err);
    }
}

/* =========================
   RENDERING & MEDIA LOGIC
   ========================= */
function extractDriveId(url) {
    const s = String(url||'');
    let m = s.match(/\/d\/([a-zA-Z0-9_-]+)/); if (m) return m[1];
    m = s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if (m) return m[1];
    return null;
}

function getAssetHTML(asset, cardId) {
    const url = asset.file_url;
    const driveId = extractDriveId(url);
    const isVideo = url.toLowerCase().match(/\.(mp4|webm|ogg|mov)$/) || url.toLowerCase().includes('video');
    if (driveId) return `<iframe src="https://drive.google.com/file/d/${driveId}/preview" allow="autoplay"></iframe>`;
    if (isVideo) return `<video id="video-${cardId}-${asset.order_index || 0}" muted playsinline autoplay loop><source src="${url}" type="video/mp4"></video>`;
    return `<img src="${url}" loading="lazy" onerror="this.src='https://via.placeholder.com/400?text=Asset+Error'">`;
}

function renderCards() {
    const grid = document.getElementById('content-grid');
    grid.innerHTML = '';
    items.forEach(it => {
        const hasMultiple = it.assets.length > 1;
        const dateStr = it.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        let mediaHtml = '';
        
        if (it.isEmpty) {
            mediaHtml = `<div style="height:100%; width: 100%; display:flex; align-items:center; justify-content:center; background:#f1f5f9; color:#94a3b8;">Pending</div>`;
        } else if (hasMultiple) {
            mediaHtml = `<div class="carousel-container" id="carousel-${it.id}">${it.assets.map(a => `<div class="carousel-item">${getAssetHTML(a, it.id)}</div>`).join('')}</div>
                <div class="carousel-nav"><button class="nav-btn" onclick="moveSlide('${it.id}', -1)">‚ùÆ</button><button class="nav-btn" onclick="moveSlide('${it.id}', 1)">‚ùØ</button></div>
                <div class="carousel-dots" id="dots-${it.id}">${it.assets.map((_, i) => `<div class="dot ${i===0?'active':''}"></div>`).join('')}</div>`;
        } else if (it.assets.length === 1) {
            mediaHtml = `<div class="carousel-item">${getAssetHTML(it.assets[0], it.id)}</div>`;
        }

        const card = document.createElement('div');
        card.className = `post-card ${it.isEmpty?'is-placeholder':''}`;
        card.innerHTML = `
            <div class="card-loader hidden" id="loader-${it.id}"><div class="spinner"></div></div>
            <div class="media-box">
                ${mediaHtml}
                ${!it.isEmpty ? `<div class="media-actions">
                    <button id="dl-btn-${it.id}" class="action-icon-btn" title="Download Individually" onclick="handleDownload('${it.id}')">${ICON_DL}</button>
                    <button class="action-icon-btn" onclick="goFullscreen('${it.id}')">‚õ∂</button>
                </div>` : ''}
            </div>
            <div class="card-details">
                <div class="badge-row">
                    <span class="day-badge">${dateStr}</span>
                    <span class="type-badge">${it.isEmpty ? 'SCHEDULED' : (hasMultiple ? 'CAROUSEL' : 'POST')}</span>
                </div>
                <div class="caption-container">
                    <p class="caption" id="caption-${it.id}">${it.caption}</p>
                    ${!it.isEmpty?`<div class="caption-controls">
                        <button class="icon-link" onclick="toggleCaption('${it.id}')">${ICON_EXPAND}</button>
                        <button class="icon-link" onclick="copyCaption('${it.id}')">${ICON_COPY}</button>
                    </div>`:''}
                </div>
                <div class="action-group">
                    <button class="btn btn-primary" ${it.isEmpty?'disabled':''} onclick="updateStatus('${it.id}', '${it.version_id}', 'approved')">Approve</button>
                    <button class="btn btn-danger-light" ${it.isEmpty?'disabled':''} onclick="rejectFlow('${it.id}', '${it.version_id}')">Edits</button>
                </div>
                <div class="status-pill st-${it.status}">${it.status}</div>
            </div>`;
        grid.appendChild(card);
    });
    updateProgress();
}

/* =========================
   DOWNLOAD SYSTEM
   ========================= */
async function handleDownload(id) {
    const it = items.find(x => x.id === id);
    if (!it || it.assets.length === 0) return;
    const btn = document.getElementById(`dl-btn-${id}`);
    btn.classList.add('is-loading');

    try {
        for (let i = 0; i < it.assets.length; i++) {
            const asset = it.assets[i];
            const name = it.assets.length > 1 ? `Design_${id}_${i+1}` : `Design_${id}`;
            if (i > 0) await new Promise(r => setTimeout(r, 600)); // Delay to prevent popup blocking
            await downloadDirect(asset.file_url, name);
        }
        showNotice(it.assets.length > 1 ? `Downloading ${it.assets.length} items...` : "Download complete!");
    } catch (e) {
        showNotice("Download failed.");
    } finally {
        btn.classList.remove('is-loading');
    }
}

async function downloadDirect(url, name) {
    if (url.includes('drive.google.com')) {
        window.open(url, '_blank');
        return;
    }
    try {
        const resp = await fetch(url);
        const blob = await resp.blob();
        const ext = url.split('.').pop().split(/[?#]/)[0] || 'jpg';
        const blobUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = `${name}.${ext}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
    } catch (err) {
        window.open(url, '_blank');
    }
}

/* =========================
   UI HELPERS
   ========================= */
function moveSlide(id, dir) {
    const it = items.find(x => x.id === id); if (!it) return;
    carouselIndices[id] = (carouselIndices[id] + dir + it.assets.length) % it.assets.length;
    document.getElementById(`carousel-${id}`).style.transform = `translateX(-${carouselIndices[id] * 100}%)`;
    const dots = document.querySelectorAll(`#dots-${id} .dot`);
    dots.forEach((d, i) => d.classList.toggle('active', i === carouselIndices[id]));
}

function startAutoSlides() {
    items.forEach(it => { if (it.assets.length > 1) carouselIntervals[it.id] = setInterval(() => moveSlide(it.id, 1), 5000); });
}

async function updateStatus(slotId, versionId, status) {
    if (!_supabase) return;
    document.getElementById(`loader-${slotId}`).classList.remove('hidden');
    await _supabase.from('post_slots').update({ current_status: status }).eq('id', slotId);
    await loadWeekData();
}

function copyCaption(id) {
    const txt = document.getElementById(`caption-${id}`).innerText;
    navigator.clipboard.writeText(txt); showNotice("Copied!");
}

function toggleCaption(id) { document.getElementById(`caption-${id}`).classList.toggle('expanded'); }
function showNotice(m) { const n = document.getElementById('notice'); n.textContent = m; setTimeout(() => n.textContent="", 3000); }
function openScreen(t) { document.getElementById('screen-title').textContent = t; document.getElementById('screen').classList.remove('hidden'); }
function closeScreen() { document.getElementById('screen').classList.add('hidden'); }
function closeMediaViewer() { document.getElementById('media-viewer').classList.add('hidden'); }

function wkGoNext() {
    activeStartDate.setDate(activeStartDate.getDate() + 7);
    loadWeekData();
}

function wkGoPrev() {
    activeStartDate.setDate(activeStartDate.getDate() - 7);
    loadWeekData();
}

function updateProgress() {
    const totalReal = items.filter(x => !x.isEmpty).length;
    const approved = items.filter(x => !x.isEmpty && x.status === 'approved').length;
    document.getElementById('approved-count').textContent = approved;
    document.getElementById('pending-count').textContent = items.filter(x => !x.isEmpty && x.status === 'pending').length;
    document.getElementById('rejected-count').textContent = items.filter(x => !x.isEmpty && x.status === 'rejected').length;
    const pct = totalReal > 0 ? Math.round((approved / totalReal) * 100) : 0;
    document.getElementById('progress-fill').style.width = pct + '%';
    document.getElementById('progressPct').textContent = pct + '%';
}

function viewAllCaptions() {
    const body = document.getElementById('screen-body');
    body.innerHTML = '';
    const realItems = items.filter(i => !i.isEmpty);
    if(realItems.length === 0) body.innerHTML = '<p>No captions available.</p>';
    realItems.forEach(it => {
        const div = document.createElement('div');
        div.style.padding = "16px"; div.style.background = "#f1f5f9"; div.style.marginBottom = "12px"; div.style.borderRadius = "12px";
        div.innerHTML = `<div style="font-weight:800; font-size:0.7rem; color:var(--brand-blue); margin-bottom:5px;">${it.date.toDateString()}</div><p style="font-size:0.85rem; white-space:pre-wrap; color:#334155;">${it.caption}</p>`;
        body.appendChild(div);
    });
    openScreen("Weekly Captions");
}

function rejectFlow(slotId, versionId) {
    const body = document.getElementById('screen-body');
    body.innerHTML = `<p style="font-size: 0.9rem; margin-bottom: 16px;">What edits are needed for this day?</p>
        <textarea id="modal-reject-reason" class="feedback-input" rows="4" style="margin-top:0;" placeholder="Add details..."></textarea>
        <button class="btn btn-accent" style="width:100%;" onclick="submitReject('${slotId}', '${versionId}')">Submit Feedback</button>`;
    openScreen("Request Edits");
}

function submitReject(slotId, versionId) {
    const reason = document.getElementById('modal-reject-reason').value;
    if (!reason) return;
    updateStatus(slotId, versionId, 'rejected');
    closeScreen();
}

function goFullscreen(id) {
    const it = items.find(x => x.id === id);
    if (!it || it.assets.length === 0) return;
    const asset = it.assets[carouselIndices[id] || 0];
    document.getElementById('media-viewer-inner').innerHTML = getAssetHTML(asset, 'viewer');
    document.getElementById('media-viewer').classList.remove('hidden');
}

async function submitFeedback(type) {
    showNotice(type === 'Call Requested' ? "Request Received!" : "Note Saved.");
    document.getElementById('feedback-note').value = "";
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
